# CAPBASETree
CAP, BASE理论

<pre>
CAP理论
      CAP原则又称为CAP定理，指的是，在一个分布式系统中，Consistency(一致性)， Availability(可用性)，
      Partion tolerance(分区容错性)，三者不可兼得。

      CAP原则是NOSQL数据库的基石。

      分布式系统的CAP理论，理论首先把分布式系统中的三个特性进行了如下归纳：
          1）一致性（Consistency):在分布式系统中的所有数据备份，在同一时刻是否同样的值
          2）可用性(Avalibility)：在集群中一部分节点故障后，集群整体状态是否还能响应客户端的读写请求
          3）分区容忍性（Partion tolerance）:以实际效果而言，分区相当于对通信的时限要求。系统如果不能在
             时限内达成数据一致性，就意味着发生了分区情况，必须就当前操作在C和A之间做出选择。

      CAP理论就是说在分布式存储系统中，最多只能实现上面的两点。而由于当前的网络硬件肯定会出现延迟丢包等问题。
      所以分区容忍性是我们必须要实现的，所以我们只能在一致性和可用性之间进行权衡，没有NoSQL系统能同时保证这
      三点。
      对于web2.0网站来说哦，关系型数据库的很多主要特性却往往无用武之地。

          1：数据库事务一致性要求
             很多实时WEB系统并不要求严格的数据库事务，对读一致性的要求很低，有些场景对写一致性要求并不高。允许
             实现最终一致性。
          2：数据库的写实时性和读实时性需求
             对关系型数据库来说，插入一条数据之后立刻查询，是肯定可以读出这条数据的，但是对于很多WEB应用
             来说，并不要求这么高的实时性，比方说发一条消息之后，过几秒乃至十几秒之后，我的订阅者才能看到这
             条动态是完全可以接受的。
          3：对复杂的SQL查询，特别是多表关联查询的需求
             任何大数据量的WEB系统，都非常忌讳多个大表的关联查询，以及复杂的数据分析类型的报表查询，特别是
             SNS类型的网站，从需求以及产品设计角度，就避免了这种情况的发生，往往更多的只是单标的主键查询，
             以及单表的简单条件分页查询，SQL的功能被极大的弱化了。
</pre>

<pre>
BASE理论
      BASE是Basic Available（基本可用）,Soft state(软状态), Eventually consistent(最终一致性)三个短语
      的简写，BASE理论是对CAP中一致性和可用性权衡的结果，其来源于对大规模互联网系统分布式实践的杰伦，是基于
      CAP定理逐步演化而来的，其核心思想是即使无法做到强一致性，但每个应用都可根据自身的业务特点，采用适当的方
      式来使系统达到最终一致性。

      基本可用：
          基本可用是指分布式系统在出现不可预知故障的时候，允许损失部分可用性，但是这绝对不等价于系统不可用，以
      下两个就是“基本可用”的典型例子。
       1）响应时间上的损失：正常情况下响应时间0.5ms，异常情况下1-2ms
       2) 功能上的损失：正常情况下，在一个电子商务网站上进行购物，消费者几乎能够顺利的完成每一笔订单，但是在一
          些节日大促高峰的时候，由于消费者的购物行为激增，为了保护购物系统的稳定性，部分消费者可能会被引导到一
          个降级页面。

       弱状态：
             也称硬状态，是指允许系统中的数据存在中间状态，并认为该中间状态的存在不会影响系统的整体可用性，即
       允许系统在不同节点的数据副本之间进行数据同步的过程存在延时。


       最终一致性：
          最终一致性强调的是系统中所有的数据副本，在经过一段时间的同步后，最终能够达到一个一致的状态。因此，最终
       一致性的本质是需要系统保证追中数据能达到一致，而不需要实时保证系统数据的最强一致性。

       因果一致性：
          因果一致性是指，如果进程A在更新完某个数据项后通知了进程B，那么进程B之后对该数据项进行更新操作的话，务
       必基于进程A更新后的更新值，即不能发生丢失丢失更新情况。与此同时，与进程A无因果关系的进程C的数据访问则没有
       这样的限制。

       读己之所写
          读己之所写是指，进程A更新一个数据项之后，它自己总是能够访问到更新过的最新值，而不会是旧值，也就是说，
       对于单个数据获取者而言，其读取到的数据一定不会比自己上次写入的值旧。因此，读己之所写也可以看做是一种特殊的因果一致性。

       会话一致性
          会话一致性将对系统数据的访问过程框定在一个会话当中：系统能保证在同一个有效的会话中实现“读己之所写”的
       一致性，也就是说，执行更新操作后，客户端能够在同一个会话中始终读取该数据项的最新值。

       单调读一致性
          单调读一致性是指如果一个进程从系统中读取出一个数据项的某个值后，那么系统对于该进程后续的任何数据访问
       都不应该返回更旧的值。

       单调写一致性
          单调写一致性是指，一个系统需要能够保证来自同一个进程的写操作被顺序地执行。

       总结来说，BASE理论面向的是大型高可用可扩展的分布式系统，和传统事务的ACID特性是相反的，它完全不同于ACID
       的强一致性模型，而是提出通过牺牲强一致性来获得可用性，并允许数据在一段时间内是不一致的，但最终达到一致状
       状态。但同时，在实际的分布式场景中，不同业务单元和组件对数据一致性的要求是不同的，因此在具体的分布式系统
       架构设计过程中，ACID特性与BASE理论往往又是结合在一起使用的。
</pre>


![](https://i.imgur.com/ehXixKe.png)

<pre>
案例分析
      1. 假设DB的更新操作是同时写北京和广州的DB都成功才返回成功
         在没有出现网络故障的时候，满足CA原则，C 即我的任何一个写入，更新操作成功并返回客户端完成后,分布式的
         所有节点在同一时间的数据完全一致， A 即我的读写操作都能够成功，但是当出现网络故障时，我不能同时
         保证CA，即P条件无法满足

      2. 假设DB的更新操作是只写本地机房成功就返回，通过binlog/oplog回放方式同步至侧边机房
         这种操作保证了在出现网络故障时,双边机房都是可以提供服务的，且读写操作都能成功，意味着他满足了AP ，但
         是它不满足C，因为更新操作返回成功后，双边机房的DB看到的数据会存在短暂不一致，且在网络故障时，不一致
         的时间差会很大（仅能保证最终一致性）

      3. 假设DB的更新操作是同时写北京和广州的DB都成功才返回成功且网络故障时提供降级服务
         降级服务，如停止写入，只提供读取功能，这样能保证数据是一致的，且网络故障时能提供服务，满足CP原则，但
         是他无法满足可用性原则
</pre>